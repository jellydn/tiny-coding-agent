## Codebase Patterns
- Use ANSI escape codes for terminal cursor positioning: `\x1b[s` (save), `\x1b[u` (restore), `\x1b[{row}H` (move to position)
- Hide cursor with `\x1b[?25l`, show with `\x1b[?25h`
- Clear line from cursor with `\x1b[K`
- StatusLine class should be a singleton exported via `getStatusLine()` helper
- Check `process.stdout.rows` to determine terminal bottom position
- Always gracefully degrade when `!process.stdout.isTTY` (non-TTY environments)
- Pre-commit hooks run lint and format:check - always run `bun run format` before committing
- Use Box flexGrow={1} in Ink to push status line to bottom of terminal
- StatusLine uses useStdout() hook to get terminal width automatically
- Use statusLineManager singleton for updating status line from non-React code
- React context subscribes to statusLineManager for reactive updates
- For list keys, use `${property}:${value.slice(0, N)}` pattern instead of index
- TextInput components: use useInput with `{ isActive: !disabled }`, track cursorPosition separately, use Text inverse for cursor


## 2026-01-20 07:13 - US-001
- Session: https://opncd.ai/s/3mkd4e
- Implemented StatusLine class in `src/cli/status-line.ts` with ANSI escape code rendering
- Exports: StatusLine class, getStatusLine() singleton, StatusDisplay and StatusLineOptions types
- Features: enable/disable, attach/detach, update(), clear(), format helpers for status/model/tokens/tool
- Updated `src/cli/index.ts` to export new status line components
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - The codebase uses husky pre-commit hooks that run lint and format checks
  - CLI uses Ink (React) for main rendering but StatusLine uses raw ANSI for non-scrolling updates
  - Export types alongside classes from index files for consumers
  - Don't import unused modules (fs import was flagged by lint)
---

## 2026-01-20 15:30 - US-002
- Session: https://opncd.ai/s/3qr9s2
- Created MessageList.tsx component with messages prop accepting ChatMessage[]
- MessageList uses flexGrow=1 to fill available vertical space
- Updated Message.tsx to show "You:" in green for user, "Assistant:" in cyan for assistant
- Exported MessageList from src/ui/components/index.ts
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Reuse existing Message component for individual message rendering
  - Use `${role}:${content.slice(0, 50)}` pattern for stable list keys instead of index
  - Follow acceptance criteria for label text and colors (override existing patterns if needed)
---

**Learnings for future iterations:**
  - Ink's Text component accepts color prop with string values like "yellow", "green", "red"
  - StatusDisplay type in cli/status-line.ts defines the canonical status values to use
  - Keep status types consistent between cli/status-line.ts and ui/components/StatusLine.tsx
---

## 2026-01-20 08:30 - US-003
- Session: https://opncd.ai/s/4np5s7
- Model display already implemented in StatusLine.tsx with truncateModel() helper
- Shows "Model: provider:model" format with gray label color
- Truncates long model names at 30 chars with ellipsis
- Connected via StatusLineContext.setModel() for state updates
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Model display was implemented alongside other status line components
  - Use Math.max to calculate truncation width based on terminal width
  - Model prop accepts full "provider:model" format for display
---

## 2026-01-20 09:00 - US-004
- Session: https://opncd.ai/s/5mn6r3
- Updated StatusLine.tsx to accept tokensUsed and tokensMax props
- Added formatCompactNumber() helper for k-formatted numbers (e.g., 12.5k)
- Context display shows "Ctx: used/max" with gray/dim label color
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - StatusLine.tsx uses separate props for tokensUsed/tokensMax instead of pre-formatted string
  - Compact formatting: >= 1000 uses `toFixed(1)` with 'k' suffix
  - Ink's Text color prop supports color names like "gray", "cyan", "yellow"
---

## 2026-01-20 10:30 - US-005
- Session: https://opncd.ai/s/7jk8l2
- Implemented timer in StatusLine.tsx using useState and useEffect
- Added toolStartTime prop instead of elapsed (tracks from tool start)
- Timer updates elapsed every 100ms while tool is active
- StatusLine shows "⚙ tool_name X.Xs" with cyan color
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Use useEffect with setInterval for real-time updates in Ink components
  - Store start timestamp (Date.now()) rather than passing elapsed to allow continuous updates
  - Clear interval on cleanup to prevent memory leaks
  - Props named toolStartTime are more accurate than elapsed for timer-based updates
---

## 2026-01-20 11:30 - US-006
- Session: https://opncd.ai/s/9pq1r2
- Created StatusLineContext.tsx with StatusLineProvider and useStatusLine hook
- Exports: StatusLineProvider, useStatusLine, StatusLineStatus type
- Provider exposes setStatus, setModel, setContext, setTool, clearTool functions
- setTool automatically captures start time using Date.now()
- Updated src/ui/index.ts to export new context components
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Use React's createContext with typed context value for type safety
  - Throw error from hook if used outside provider (helps catch usage errors early)
  - Export type alongside hook for consumers to use in their code
  - setTool helper that combines setToolState and setToolStartTime for atomic updates
  - Pre-commit hooks run format:check which requires running `bun run format` first
---

## 2026-01-20 12:00 - US-007
- Session: https://opncd.ai/s/8rs3t4
- Integrated StatusLine into App.tsx with StatusLineProvider wrapper
- StatusLineWrapper component conditionally renders status line based on shouldUseInk()
- Status line only shows when there is actual content to display
- Updated src/ui/index.ts to export StatusLine component
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - StatusLine uses useStdout() hook to get terminal width automatically
  - Box flexGrow={1} allows StatusLine to push to bottom of terminal
  - Use conditional rendering based on context values to avoid empty status line
  - shouldUseInk() checks noColor, jsonMode, and isTTY for proper fallback
---

## 2026-01-20 13:30 - US-008
- Session: https://opncd.ai/s/6op8q1
- Created status-line-manager.ts for non-React status updates
- Updated StatusLineContext.tsx to subscribe to statusLineManager
- Integrated status updates in handleChat: set 'thinking' at start, 'ready' on completion, 'error' on error
- Integrated status updates in handleRun: same pattern as handleChat
- Updates context usage via setContext() when contextStats available
- Updates tool state via setTool()/clearTool() during tool execution
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Created statusLineManager singleton that both React and non-React code can use
  - React context subscribes to manager updates via useEffect for reactivity
  - TypeScript's bare `catch {}` syntax may not work in all configurations - use `catch (e) {}` instead
  - statusLineManager.notify() calls all listeners after any state change
  - Outer try-catch handles errors for the entire runPrompt/handleRun function
  - Error status is set briefly, then reset to ready after logging
---

## 2026-01-20 14:00 - US-009
- Session: https://opncd.ai/s/6op8q1
- Tool execution updates were implemented as part of US-008
- setTool() called when tool starts (status "running" in agent stream)
- clearTool() called when tool completes (no running tools)
- Tool elapsed time tracked via toolStartTime set in statusLineManager
- Works for all built-in tools via agent stream integration
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Agent stream yields toolExecutions with status before and after execution
  - Use chunk.toolExecutions.find((te) => te.status === "running") to detect active tool
  - setTool automatically captures Date.now() as start time
  - StatusLine component calculates elapsed time from toolStartTime
---

## 2026-01-20 15:00 - US-010
- Session: https://opncd.ai/s/7qr9s2
- Added showStatusLine property to statusLineManager and StatusLineContext
- Added --no-status CLI flag parsing in main.tsx
- Updated App.tsx StatusLineWrapper to check showStatusLine before rendering
- Updated help text to document --no-status flag
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - statusLineManager.showStatusLine getter controls whether status line renders
  - Call statusLineManager.setShowStatusLine(false) early in main() for CLI flag
  - React context subscribes to showStatusLine changes via useEffect
  - StatusLine only renders when showStatusLine && shouldUseInk() && has content
---


## 2026-01-20 16:30 - US-003
- Session: https://opncd.ai/s/3qr9s2
- Created StreamingText.tsx component with text and isStreaming props
- Blinking cursor (▋) toggles every 500ms using setInterval
- Cursor hides when isStreaming is false
- Exported from src/ui/components/index.ts
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Use setInterval in useEffect for blinking cursor animation
  - Cleanup interval on unmount and when isStreaming changes
  - Cursor character ▋ (block) works well for terminal blinking indicator
---

## 2026-01-20 17:00 - US-004
- Session: https://opncd.ai/s/8ts4q5
- Created ThinkingIndicator.tsx component wrapping existing Spinner
- Uses Spinner internally with isLoading mapped from visible prop
- Shows animated spinner with 'Thinking...' text and elapsed time
- Exported from src/ui/components/index.ts
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - ThinkingIndicator is a thin wrapper around existing Spinner component
  - Use simple prop mapping (visible -> isLoading) for component variations
  - Export new components from index.ts for discoverability
 ---

## 2026-01-20 17:30 - US-006
- Session: https://opncd.ai/s/abc123
- Created TextInput.tsx component with value, onChange, onSubmit, disabled props
- Uses Ink's useInput hook for keyboard handling
- Shows '>' prompt prefix with gray color
- Handles backspace, delete, arrow keys, escape, and regular input
- Clears input after submit when value is not empty
- Exported from src/ui/components/index.ts
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Use useInput with { isActive: !disabled } to disable input when processing
  - Track cursorPosition separately from value for proper cursor rendering
  - Use Text inverse prop for cursor rendering in terminal
  - Always check disabled prop first in useInput handler
  - Export new components from index.ts for discoverability
---



## 2026-01-20 17:45 - US-007
- Session: https://opncd.ai/s/def456
- Created CommandMenu.tsx component with Command interface
- Shows list of commands: /help, /clear, /model, /memory, /exit
- Accepts filter prop to filter commands by prefix
- Highlights selected command with arrow keys and ▼ indicator
- Calls onSelect when Enter pressed, onClose when Escape pressed
- Exported CommandMenu and Command type from src/ui/components/index.ts
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Use useRef to track previous prop values for effect comparisons
  - ESLint exhaustive-deps rule may flag filter as unnecessary dependency even when needed
  - Use Text inverse with color for selection indicators
  - Export interfaces alongside components for consumers to use in their code
---

## 2026-01-20 22:55 - US-008
- Session: https://opncd.ai/s/m9pq2r5
- Created ModelPicker.tsx component with ModelPickerItem interface
- Shows list of models with provider detection using detectProvider()
- Indicates current active model with [active] label
- Arrow keys navigate, Enter selects model, Escape closes
- Exports: ModelPicker, ModelPickerItem, DEFAULT_MODELS
- Updated src/ui/components/index.ts to export new components
- Typecheck: pass, Lint: pass, Test: pass (241 tests), Format: pass

**Learnings for future iterations:**
  - Model provider is detected from model ID using regex patterns in model-registry.ts
  - Model names follow provider:model format (e.g., "ollama/llama3.2", "openrouter/openai/gpt-4o")
  - Use try/catch for detectProvider() in case model pattern doesn't match
  - DEFAULT_MODELS provides a curated list of popular models across providers
  - Follow CommandMenu pattern for selection UI (▼ indicator, inverse blue for selected)
---
